<div *ngIf="isLoading" class="loading-spinner">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div *ngIf="!isLoading && user" class="user-details">
  <!-- Profile Information -->
  <div class="profile-card" [ngStyle]="profileBackgroundStyle">
    <div class="online-status">
      <span class="badge" [ngClass]="user.is_online ? 'badge-success' : 'badge-secondary'">
        {{ user.is_online ? 'Online' : 'Offline' }}
      </span>
    </div>
    <img
      *ngIf="user.profile?.avatar || user.avatar"
      [src]="user.profile?.avatar || user.avatar"
      alt="Avatar"
      class="avatar"
    />
    <div class="level-info">
      <h4>{{ user.level }}</h4>
    </div>
    <h3>{{ user.profile?.display_name || user.display_name || user.username }}</h3>
    <p><strong>Email:</strong> {{ user.email }}</p>

  </div>

  <!-- Tabs for History and Ranking -->
  <div class="tab-controls">
    <button (click)="activeTab = 'history'" [ngClass]="{'active-tab': activeTab === 'history'}">History</button>
    <button (click)="activeTab = 'ranking'" [ngClass]="{'active-tab': activeTab === 'ranking'}">Ranking</button>
  </div>

  <!-- History Tab Content -->
  <div *ngIf="activeTab === 'history'" class="tab-content">
    <div class="sub-tab-controls">
      <button (click)="activeHistoryTab = 'games'" [ngClass]="{'active-sub-tab': activeHistoryTab === 'games'}">Games</button>
      <button (click)="activeHistoryTab = 'tournaments'" [ngClass]="{'active-sub-tab': activeHistoryTab === 'tournaments'}">Tournaments</button>
    </div>

    <!-- Game History with Filters -->
    <div *ngIf="activeHistoryTab === 'games'" class="history-section">
      <h3>Game History</h3>
      <div class="controls">
        <input type="text" [(ngModel)]="gameSearchName" (input)="applyGameFilters()" placeholder="Search by name" class="filter-input" />
        <label>
          Start Date:
          <input type="date" [(ngModel)]="gameStartDate" (change)="applyGameFilters()" />
        </label>
        <label>
          End Date:
          <input type="date" [(ngModel)]="gameEndDate" (change)="applyGameFilters()" />
        </label>
        <select [(ngModel)]="gameSortOrder" (change)="applyGameFilters()" class="sort-select">
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div *ngIf="filteredGameHistory.length > 0; else noGamesTemplate">
        <div *ngFor="let game of filteredGameHistory" class="game-item">
          <a [routerLink]="['/games/details/', game.id]" class="game-link">
            <strong>{{ game.player1.username }}</strong> vs <strong>{{ game.player2.username || 'AI' }}</strong>
          </a>
          <p class="game-mode">{{ game.game_mode }} | {{ game.score_player1 }} : {{ game.score_player2 }}</p>
        </div>
      </div>
    </div>

    <!-- Tournament History with Filters -->
    <div *ngIf="activeHistoryTab === 'tournaments'" class="history-section">
      <h3>Tournament History</h3>
      <div class="controls">
        <input type="text" [(ngModel)]="tournamentSearchName" (input)="applyTournamentFilters()" placeholder="Search by name" class="filter-input" />
        <label>
          Start Date:
          <input type="date" [(ngModel)]="tournamentStartDate" (change)="applyTournamentFilters()" />
        </label>
        <label>
          End Date:
          <input type="date" [(ngModel)]="tournamentEndDate" (change)="applyTournamentFilters()" />
        </label>
        <select [(ngModel)]="tournamentSortOrder" (change)="applyTournamentFilters()" class="sort-select">
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div *ngIf="filteredTournamentHistory.length > 0; else noTournamentsTemplate">
        <div *ngFor="let tournament of filteredTournamentHistory" class="tournament-item">
          <a [routerLink]="['/games/tournament/details', tournament.id]" class="tournament-link">
            <strong>{{ tournament.name }}</strong>
          </a>
          <p class="tournament-type">{{ tournament.type }} | {{ tournament.status }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Ranking Tab Content -->
  <div *ngIf="activeTab === 'ranking'" class="tab-content leaderboard">
    <div class="ranking-section">
      <h4>Game Stats</h4>
      <ul>
        <li><strong>Total Wins:</strong> {{ gameStats.total_wins }} (Rank: {{ gameStats.win_rank }})</li>
        <li><strong>Total Games Played:</strong> {{ gameStats.total_games_played }} (Rank: {{ gameStats.game_rank }})</li>
        <li><strong>Average Score:</strong> {{ gameStats.avg_score | number: '1.1-1' }} (Rank: {{ gameStats.avg_score_rank }})</li>
      </ul>
    </div>
    <div class="ranking-section">
      <h4>Tournament Stats</h4>
      <ul>
        <li><strong>Total Tournaments Won:</strong> {{ tournamentStats.total_tournaments_won }} (Rank: {{ tournamentStats.win_rank }})</li>
        <li><strong>Total Tournaments Participated:</strong> {{ tournamentStats.total_tournaments_participated }} (Rank: {{ tournamentStats.participation_rank }})</li>
      </ul>
    </div>
  </div>

  <!-- No Games or Tournaments Templates -->
  <ng-template #noGamesTemplate>
    <p class="alert alert-info text-center mb-0">This user has no games.</p>
  </ng-template>
  <ng-template #noTournamentsTemplate>
    <p class="alert alert-info text-center mb-0">This user has no tournaments.</p>
  </ng-template>
</div>
